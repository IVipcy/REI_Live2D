# 安全なHTTPSリダイレクト設定（環境タイプに依存しない）
files:
  "/opt/elasticbeanstalk/tasks/bundlelogs.d/01-nginx-redirect.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      /var/log/nginx/*

container_commands:
  01_setup_https_redirect:
    command: |
      # Nginx設定ファイルを作成（Single Instance用）
      if [ -f /etc/nginx/conf.d/elasticbeanstalk-nginx-docker-proxy.conf ]; then
        cat > /etc/nginx/conf.d/https_redirect.conf <<EOF
      server {
          listen 80;
          server_name _;
          
          # Let's Encrypt用の例外
          location /.well-known {
              allow all;
          }
          
          # その他のリクエストはHTTPSへリダイレクト
          location / {
              return 301 https://\$host\$request_uri;
          }
      }
      EOF
      fi
    ignoreErrors: true
    
  02_reload_nginx:
    command: |
      if [ -f /etc/nginx/conf.d/https_redirect.conf ]; then
        service nginx reload || true
      fi
    ignoreErrors: true 