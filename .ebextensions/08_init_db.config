container_commands:
  01_create_data_directory:
    command: |
      echo "===== Creating data directory =====" >> /var/log/chromadb_init.log
      mkdir -p /var/app/current/data
      chmod 755 /var/app/current/data
      echo "Data directory created" >> /var/log/chromadb_init.log
    ignoreErrors: false
    
  02_create_chromadb_directory:
    command: |
      echo "===== Creating chromadb directory =====" >> /var/log/chromadb_init.log
      mkdir -p /var/app/current/data/chroma_db
      chmod 755 /var/app/current/data/chroma_db
      echo "ChromaDB directory created" >> /var/log/chromadb_init.log
    ignoreErrors: false
    
  03_remove_old_chromadb:
    command: |
      echo "===== Removing old ChromaDB =====" >> /var/log/chromadb_init.log
      if [ -d "/var/app/current/data/chroma_db" ]; then
        rm -rf /var/app/current/data/chroma_db
        echo "既存のChroma DBを削除しました" >> /var/log/chromadb_init.log
      fi
      
  04_copy_uploads:
    command: |
      echo "===== Copying uploads =====" >> /var/log/chromadb_init.log
      if [ -d "/var/app/ondeck/uploads" ]; then
        mkdir -p /var/app/current/uploads
        cp -r /var/app/ondeck/uploads/* /var/app/current/uploads/
        echo "uploadsディレクトリをコピーしました" >> /var/log/chromadb_init.log
        ls -la /var/app/current/uploads/ >> /var/log/chromadb_init.log
      else
        echo "警告: /var/app/ondeck/uploadsが見つかりません" >> /var/log/chromadb_init.log
      fi
      
  05_list_structure:
    command: |
      echo "===== Directory structure =====" >> /var/log/chromadb_init.log
      echo "Current directory: $(pwd)" >> /var/log/chromadb_init.log
      echo "--- /var/app/current/ ---" >> /var/log/chromadb_init.log
      ls -la /var/app/current/ >> /var/log/chromadb_init.log
      echo "--- Python path ---" >> /var/log/chromadb_init.log
      which python >> /var/log/chromadb_init.log
      python --version >> /var/log/chromadb_init.log
      
  06_init_chromadb:
    command: |
      echo "===== Initializing ChromaDB =====" >> /var/log/chromadb_init.log
      cd /var/app/current
      source /var/app/venv/*/bin/activate
      echo "Python path: $(which python)" >> /var/log/chromadb_init.log
      python -c "import sys; print('Python version:', sys.version)" >> /var/log/chromadb_init.log 2>&1
      python -c "import sys; import traceback; from modules.rag_system import RAGSystem; import os; print('ChromaDB初期化を開始します...'); uploads_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'uploads'); print(f'uploadsディレクトリ: {uploads_dir}'); rag = RAGSystem(); print('ChromaDBの初期化が完了しました')" >> /var/log/chromadb_init.log 2>&1 || echo "ChromaDB init failed with error code: $?" >> /var/log/chromadb_init.log
    ignoreErrors: true
    
  07_set_permissions:
    command: |
      chown -R webapp:webapp /var/app/current/data || true
      chown -R webapp:webapp /var/app/current/uploads || true
    ignoreErrors: true 