option_settings:
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx
  
  # ALB設定
  aws:elbv2:listener:80:
    Protocol: HTTP
    
  # HTTPS対応（証明書がある場合はコメントを外して使用）
  # aws:elbv2:listener:443:
  #   Protocol: HTTPS
  #   SSLCertificateArns: arn:aws:acm:ap-northeast-1:XXXXXXXXX:certificate/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
  #   SSLPolicy: ELBSecurityPolicy-2016-08
    
  # WebSocketルール
  aws:elbv2:listenerrule:wshttp:
    PathPatterns: /socket.io/*
    Priority: 1
    Process: default
    
  # アプリケーションプロセス設定
  aws:elasticbeanstalk:environment:process:default:
    Port: 80
    Protocol: HTTP
    HealthCheckPath: /
    HealthCheckInterval: 30
    StickinessEnabled: true
    StickinessLBCookieDuration: 86400

# ALBのスティッキーセッションを有効化（WebSocketに必要）
Resources:
  AWSEBV2LoadBalancerTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: true
        - Key: stickiness.type
          Value: lb_cookie
        - Key: stickiness.lb_cookie.duration_seconds
          Value: 86400 