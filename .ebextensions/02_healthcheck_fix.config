# ヘルスチェック設定の修正
option_settings:
  # ヘルスチェック関連（正しいオプションのみ使用）
  aws:elasticbeanstalk:healthreporting:system:
    SystemType: enhanced
    EnhancedHealthAuthEnabled: true
    
  # アプリケーションヘルスチェック設定（正しいnamespace使用）
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: /
    
  # デプロイメント設定
  aws:autoscaling:updatepolicy:rollingupdate:
    RollingUpdateEnabled: true
    RollingUpdateType: Health
    Timeout: PT30M

# デプロイメント後のヘルスチェック確認
files:
  "/opt/elasticbeanstalk/hooks/configdeploy/post/99_restart_delayed.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      # アプリケーション起動の待機
      sleep 30
      
      # プロセス確認
      ps aux | grep -v grep | grep python || echo "Python process check completed"
      
      # ポート確認  
      netstat -tlnp | grep :8000 || echo "Port check completed"
      
      echo "Health check preparation completed"

container_commands:
  01_wait_for_app:
    command: |
      # アプリケーションが完全に起動するまで待機
      for i in {1..60}; do
        if curl -f http://localhost:8000/ > /dev/null 2>&1; then
          echo "Application is ready"
          break
        fi
        echo "Waiting for application... ($i/60)"
        sleep 5
      done 